function WebService(){}WebService.prototype.constructor=WebService,WebService.prototype.getJSON=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4==this.readyState&&200==this.status&&b(null,JSON.parse(c.response))},c.open("GET",a,!0),c.send()},WebService.prototype.getFeed=function(a,b,c){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&c(null,a,JSON.parse(e.response))},e.open("GET","feed?name="+a+"&sinceID="+b,!0),e.send()};function IPRange(a,b){this.start=a,this.end=b}IPRange.prototype.constructor=IPRange,IPRange.prototype.inRange=function(a){var b=this.atoi(a);return b>=this.atoi(this.start)&&b<=this.atoi(this.end)},IPRange.prototype.atoi=function(a){var b=a.split(".").map(function(c){return parseInt(c)});return(b[0]?b[0]<<24:0)+(b[1]?b[1]<<16:0)+(b[2]?b[2]<<8:0)+b[3]};function MapRegion(a,b,c,e,f=""){this.x1=a,this.y1=b,this.x2=c,this.y2=e,this.name=f,this.ipRanges=[],this.endpoints=[]}MapRegion.prototype.constructor=MapRegion,MapRegion.prototype.addIPRange=function(a,b){this.ipRanges.push(new IPRange(a,b))},MapRegion.prototype.inRegion=function(a){for(var b=0;b<this.ipRanges.length;b++)if(this.ipRanges[b].inRange(a))return!0;return!1},MapRegion.prototype.newEndpoint=function(a,b){return map_coords=this.getNextEPLocation(),ep=new Endpoint(a,b,map_coords[0],map_coords[1]),ep.label=this.name,this.endpoints.push(ep),ep},MapRegion.prototype.getNextEPLocation=function(){for(idx=this.endpoints.length,pwr=0;idx>=Math.pow(4,pwr);)idx-=Math.pow(4,pwr),pwr++;return grid_dim=Math.pow(2,pwr),spacing=Math.pow(.5,pwr),rel_start=Math.pow(.5,pwr+1),relx=rel_start+idx%grid_dim*spacing,rely=rel_start+Math.floor(idx/grid_dim)*spacing,x=this.x1+(this.x2-this.x1)*relx,y=this.y1+(this.y2-this.y1)*rely,[x,y]};function Endpoint(a,b,c,e){this.offmap=!1,(null==c||null==e)&&(this.offmap=!0),this.x=c,this.y=e,this.ip=a,this.type=b,this.label=""}Endpoint.prototype.constructor=Endpoint;function Alert(a,b,c,e,f){this.alertTime=c,this.src=a,this.dst=b,this.type=e,this.msg=f}Alert.prototype.constructor=Alert;function Configuration(a){this.webConnection=new WebService,this.map_url=null,this.loaded=!1,this.loadCallback=a,this.loadConfig()}Configuration.prototype.constructor=Configuration,Configuration.prototype.loadConfig=function(){this.loadAppConfig=this.loadAppConfig.bind(this),this.loadMapConfig=this.loadMapConfig.bind(this),this.webConnection.getJSON("appconfig",this.loadAppConfig)},Configuration.prototype.loadAppConfig=function(a,b){null==a&&(this.refreshRate=b.refreshRate,this.maxZoom=b.maxZoom,this.zoomRate=b.zoomRate,this.raySize=b.raySize,this.rayGlow=b.rayGlow,this.raySpeed=b.raySpeed,this.endpointSize=b.endpointSize,this.endpointGlow=b.endpointGlow,this.endpointExternalColor=b.endpointExternalColor,this.endpointFadeinRate=b.endpointFadeinRate,this.endpointFadeoutRate=b.endpointFadeoutRate,this.endpointHighlightRate=b.endpointHighlightRate,this.labelFontSize=b.labelFontSize,this.labelFontColor=b.labelFontColor,this.showLocalLabels=b.showLocalLabels,this.logoFontSize=b.logoFontSize,this.logoText=b.logoText,this.UIOutlineColor=b.UIOutlineColor,this.UIFillColor=b.UIFillColor,this.alertListSize=b.alertListSize,this.alertListFontSize=b.alertListFontSize,this.scrollRate=b.scrollRate,this.ep_timeout=b.ep_timeout,this.alertEndpointColors=b.alertEndpointColors,this.alertRayColors=b.alertRayColors,this.feedMaxIDs=b.feedMaxIDs,this.loaded=!0,this.webConnection.getJSON("maps",this.loadMapConfig))},Configuration.prototype.loadMapConfig=function(a,b){if(null==a){for(this.maps=new Map,this.defaultMap=b.defaultMap,j=0;j<b.maps.length;j++)this.maps.set(b.maps[j].name,b.maps[j]);this.loadCallback()}},Configuration.prototype.getEPColor=function(a){return a in this.alertEndpointColors?this.alertEndpointColors[a]:this.alertEndpointColors["default"]},Configuration.prototype.getRayColor=function(a){return a in this.alertRayColors?this.alertRayColors[a]:this.alertRayColors["default"]},Configuration.prototype.getMapRegions=function(a){for(m=this.maps.get(a),out=[],j=0;j<m.regions.length;j++){for(r=new MapRegion(m.regions[j].x1,m.regions[j].y1,m.regions[j].x2,m.regions[j].y2,m.regions[j].name),k=0;k<m.regions[j].ipranges.length;k++)r.addIPRange(m.regions[j].ipranges[k].start,m.regions[j].ipranges[k].end);out.push(r)}return out};function Controller(){this.map_img=document.createElement("IMG"),this.map_img.height=0,this.map_img.width=0,this.lastUpdate=null,this.loaded=!1,this.config=null,this.feedMaxID=new Map,this.asyncLoadConfig=this.asyncLoadConfig.bind(this),this.loadMap=this.loadMap.bind(this),this.getAlerts=this.getAlerts.bind(this),this.processAlerts=this.processAlerts.bind(this),this.asyncLoadConfig(),this.endpoints=new Map,this.alertQueue=[]}Controller.prototype.constructor=Controller,Controller.prototype.asyncLoadConfig=function(){null==this.config&&(this.config=new Configuration(this.asyncLoadConfig)),this.config.loaded&&this.loadMap(this.config.defaultMap)},Controller.prototype.loadMap=function(a){if(this.stopAlerts(),x=this,this.loaded=!1,this.map_img.onload=function(){alertMapController.width=alertMapController.map_img.naturalWidth,alertMapController.height=alertMapController.map_img.naturalHeight,alertMapController.loaded=!0,alertMapController.lastUpdate=Date.now()},this.map_img.src="images/"+this.config.maps.get(a).map_url,this.map=this.map_img,this.mapRegions=this.config.getMapRegions(a),this.feeds=this.config.maps.get(a).feeds,0==this.feedMaxID.size)for(var b=0;b<this.config.feedMaxIDs.length;b++)this.feedMaxID.set(this.config.feedMaxIDs[b][0],this.config.feedMaxIDs[b][1]);this.endpoints=new Map,this.startAlerts()},Controller.prototype.addAlert=function(a,b,c,e,f,g){s=this.getIPEndpoint(a,f),s.label=null==b?"":b,d=this.getIPEndpoint(c,f),d.label=null==e?"":e,this.alertQueue.push(new Alert(s,d,Date.now(),f,g))},Controller.prototype.getIPEndpoint=function(a){return this.endpoints.has(a)?this.endpoints.get(a):(ep=this.createIPEndpoint(a),this.endpoints.set(a,ep),ep)},Controller.prototype.createIPEndpoint=function(a,b){for(var c=0;c<this.mapRegions.length;c++)if(this.mapRegions[c].inRegion(a))return this.mapRegions[c].newEndpoint(a,b);return new Endpoint(a,b,null,null)},Controller.prototype.startAlerts=function(){this.stopAlertProcessing=!1,setTimeout(this.getAlerts,this.refreshRate)},Controller.prototype.stopAlerts=function(){this.stopAlertProcessing=!0},Controller.prototype.getAlerts=function(){for(var a=0;a<this.feeds.length;a++)w=new WebService,w.getFeed(this.feeds[a],this.feedMaxID.get(this.feeds[a]),this.processAlerts);!1==this.stopAlertProcessing&&setTimeout(this.getAlerts,this.config.refreshRate)},Controller.prototype.processAlerts=function(a,b,c){if(null==a){var e=0,f=0;this.feedMaxID.has(b)&&(e=this.feedMaxID.get(b));for(var g=0;g<c.alerts.length;g++)c.alerts[g].id>f&&(f=c.alerts[g].id),c.alerts[g].id>e&&this.addAlert(c.alerts[g].src,c.alerts[g].src_label,c.alerts[g].dst,c.alerts[g].dst_label,c.alerts[g].type,c.alerts[g].msg);this.feedMaxID.has(b)?this.feedMaxID.get(b)<f&&this.feedMaxID.set(b,f):this.feedMaxID.set(b,f),this.lastUpdate=Date.now()}else console.log(a+" "+c)};var alertMapController=new Controller;